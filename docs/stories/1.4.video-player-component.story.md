# Story 1.4: Video Player Component

## Status
Ready for Review

## Story
**As a** developer,
**I want** a reusable video player component with optimization features,
**so that** videos across the site load efficiently and play smoothly.

## Acceptance Criteria

1. VideoPlayer component accepts props: src, poster, autoplay, muted, loop, className
2. Component supports autoplay with muted attribute (browser requirement)
3. Lazy loading is implemented (video loads when near viewport)
4. Poster image displays while video loads
5. Play/pause toggle is available on click/tap
6. Component handles loading and error states gracefully
7. Video uses `playsinline` attribute for iOS compatibility
8. Component is responsive (fills container width, maintains aspect ratio)
9. Multiple video formats supported via source elements (MP4 primary, WebM fallback)

## Tasks / Subtasks

- [x] Task 1: Create VideoPlayer Component Structure (AC: 1)
  - [x] Create `src/components/video/VideoPlayer.tsx` file
  - [x] Define TypeScript interface for props: `src`, `poster?`, `autoplay?`, `muted?`, `loop?`, `className?`
  - [x] Use `forwardRef` to allow ref forwarding to video element
  - [x] Export from `src/components/video/index.ts`
- [x] Task 2: Implement Lazy Loading with Intersection Observer (AC: 3)
  - [x] Create `useIntersectionObserver` hook or use built-in Intersection Observer API
  - [x] Set up ref on video element to observe when it enters viewport
  - [x] Only load video source when element is near viewport (threshold: 0.1 or similar)
  - [x] Add state to track if video should be loaded
- [x] Task 3: Implement Video Element with Multiple Formats (AC: 9)
  - [x] Render `<video>` element with required attributes
  - [x] Add multiple `<source>` elements for MP4 and WebM formats
  - [x] Set `type` attribute for each source (video/mp4, video/webm)
  - [x] Add fallback text for browsers without video support
- [x] Task 4: Add iOS and Autoplay Support (AC: 2, 7)
  - [x] Add `playsInline` attribute (camelCase in React) for iOS compatibility
  - [x] Ensure `autoplay` is only enabled when `muted={true}` (browser requirement)
  - [x] Add `muted` and `loop` attributes based on props
- [x] Task 5: Implement Poster Image (AC: 4)
  - [x] Add `poster` attribute to video element
  - [x] Accept poster URL via props
  - [x] Ensure poster displays before video loads and plays
- [x] Task 6: Implement Play/Pause Toggle (AC: 5)
  - [x] Add click/tap event handler to video element
  - [x] Toggle between `video.play()` and `video.pause()` on click
  - [x] Optional: Add visual play/pause overlay indicator
  - [x] Use `useRef` to access video element DOM API
- [x] Task 7: Handle Loading and Error States (AC: 6)
  - [x] Add `onLoadStart`, `onCanPlay`, `onError` event handlers
  - [x] Create state to track loading status: 'idle' | 'loading' | 'ready' | 'error'
  - [x] Display loading spinner or skeleton while video loads
  - [x] Display error message if video fails to load
  - [x] Log errors for debugging
- [x] Task 8: Implement Responsive Styling (AC: 8)
  - [x] Use `w-full` for full container width
  - [x] Set `aspect-video` (16:9) or accept custom aspect ratio
  - [x] Use `object-cover` or `object-contain` based on use case
  - [x] Allow className prop to override default styles via `cn()` utility
- [x] Task 9: Write Unit Tests (AC: 1-9)
  - [x] Create `src/components/video/VideoPlayer.test.tsx`
  - [x] Test: renders video element with correct src
  - [x] Test: applies poster attribute when provided
  - [x] Test: adds playsInline attribute
  - [x] Test: renders multiple source elements
  - [x] Test: handles play/pause toggle (mock video API)
  - [x] Test: lazy loading behavior (mock Intersection Observer)
  - [x] Test: displays error state when video fails to load

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 Completion Notes]
- Tailwind CSS v4 uses `@theme inline` in CSS - design tokens in `src/app/globals.css`
- Dark theme is default
- Accent color: amber (`#d97706` / `text-amber-600`)
- `cn()` utility available in `src/lib/utils.ts`
- Testing infrastructure set up with Vitest + Testing Library
- Focus-visible styles and reduced-motion support in global CSS

### Project Structure Notes
[Source: architecture/unified-project-structure.md]
- VideoPlayer component goes in: `src/components/video/VideoPlayer.tsx`
- Export from barrel file: `src/components/video/index.ts`
- Co-locate tests: `src/components/video/VideoPlayer.test.tsx`
- Video files stored in: `public/videos/`

### Component Specifications
[Source: architecture/components.md#videoplayer-component]
- **Responsibility:** Reusable video player with lazy loading, autoplay support, and optimization features
- **Key Interfaces:**
  - `src: string` - Video source URL
  - `poster?: string` - Poster image URL
  - `autoplay?: boolean` - Enable autoplay (muted)
  - `loop?: boolean` - Enable looping
  - `onPlay?: () => void` - Play callback
  - `onError?: (error: Error) => void` - Error callback
- **Dependencies:** None (vanilla React)
- **Technology Stack:** React component with HTML5 video API, Intersection Observer for lazy loading

### TypeScript Interface Definition
```typescript
interface VideoPlayerProps {
  src: string;
  poster?: string;
  autoplay?: boolean;
  muted?: boolean;
  loop?: boolean;
  className?: string;
  onPlay?: () => void;
  onPause?: () => void;
  onError?: (error: Error) => void;
}
```

### Component Template Pattern
[Source: architecture/frontend-architecture.md#component-template]
- Use `forwardRef` for components that need ref forwarding (VideoPlayer needs ref)
- Use `cn()` utility for conditional class merging
- Import pattern: `import { cn } from '@/lib/utils';`

### Lazy Loading Pattern with Intersection Observer
```typescript
const [shouldLoad, setShouldLoad] = useState(false);
const videoRef = useRef<HTMLVideoElement>(null);

useEffect(() => {
  const observer = new IntersectionObserver(
    ([entry]) => {
      if (entry.isIntersecting) {
        setShouldLoad(true);
        observer.disconnect();
      }
    },
    { threshold: 0.1 }
  );

  if (videoRef.current) {
    observer.observe(videoRef.current);
  }

  return () => observer.disconnect();
}, []);
```

### Multiple Video Format Pattern
```typescript
<video ref={videoRef} poster={poster} playsInline muted={muted} loop={loop}>
  <source src={`${src}.webm`} type="video/webm" />
  <source src={`${src}.mp4`} type="video/mp4" />
  Your browser does not support the video tag.
</video>
```

### Coding Standards
[Source: architecture/coding-standards.md]
- **File naming:** PascalCase for components (`VideoPlayer.tsx`)
- **Imports:** Use absolute imports with `@/` alias
- **Component Structure:** One component per file, co-locate tests
- **Video Files:** Store in `public/videos/`, use descriptive names, include poster images

### Browser Autoplay Requirements
[Source: Standard web best practices]
- Autoplay only works when video is `muted={true}`
- iOS requires `playsInline` attribute to prevent fullscreen
- Modern browsers block autoplay with sound

### Accessibility Considerations
- Video should have appropriate ARIA labels if interactive
- Provide fallback text for unsupported browsers
- Ensure play/pause controls are keyboard accessible if custom controls added
- Consider `prefers-reduced-motion` for autoplay behavior

### Performance Optimization
[Source: architecture/security-and-performance.md]
- Lazy load videos to reduce initial page load
- Use poster images to show content before video loads
- Compress videos (target <5MB for short clips)
- Use appropriate video formats (MP4 for compatibility, WebM for smaller size)

## Testing

**Test file location:** `src/components/video/VideoPlayer.test.tsx`

**Testing frameworks:**
[Source: architecture/testing-strategy.md]
- Vitest + Testing Library for component tests
- Tests use `describe`, `it`, `expect`, `vi` from vitest
- Use `render`, `screen` from `@testing-library/react`

**Required test pattern:**
```typescript
// src/components/video/VideoPlayer.test.tsx
import { render, screen } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { VideoPlayer } from './VideoPlayer';

// Mock IntersectionObserver
beforeEach(() => {
  global.IntersectionObserver = vi.fn().mockImplementation(() => ({
    observe: vi.fn(),
    disconnect: vi.fn(),
  }));
});

describe('VideoPlayer', () => {
  it('renders video element with correct src', () => {
    render(<VideoPlayer src="/videos/test.mp4" />);
    const video = screen.getByRole('video');
    expect(video).toBeInTheDocument();
  });

  it('applies poster attribute when provided', () => {
    render(<VideoPlayer src="/videos/test.mp4" poster="/images/poster.jpg" />);
    const video = screen.getByRole('video') as HTMLVideoElement;
    expect(video.poster).toContain('poster.jpg');
  });

  it('adds playsInline attribute for iOS', () => {
    render(<VideoPlayer src="/videos/test.mp4" />);
    const video = screen.getByRole('video') as HTMLVideoElement;
    expect(video).toHaveAttribute('playsinline');
  });

  it('renders multiple source elements', () => {
    const { container } = render(<VideoPlayer src="/videos/test" />);
    const sources = container.querySelectorAll('source');
    expect(sources.length).toBeGreaterThanOrEqual(2);
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2025-12-13 | 1.1 | Implementation complete - all tasks done | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - implementation completed without errors.

### Completion Notes List
- VideoPlayer component with forwardRef for ref forwarding
- TypeScript interface: VideoPlayerProps with src, poster, autoplay, muted, loop, className, onPlay, onPause, onError
- Lazy loading via IntersectionObserver (threshold 0.1, rootMargin 50px)
- Multiple video format support: extensionless src renders WebM + MP4 sources, src with extension renders single source
- iOS compatibility: playsInline attribute always present
- Autoplay support: only triggers when muted=true (browser requirement)
- Play/pause toggle: click handler on video element, visual play button overlay when paused
- Loading state: animated spinner with amber accent color
- Error state: error icon with message "Failed to load video"
- Responsive: w-full, aspect-video (16:9), object-cover, rounded-lg container
- Poster image placeholder shown before lazy load triggers
- Dark theme styling: bg-black/50 container, amber-500 accent for spinner and focus rings
- Focus-visible rings for keyboard accessibility
- 27 unit tests covering: rendering, poster image, iOS compatibility, video sources, attributes, play/pause toggle, event callbacks, loading state, error state, lazy loading, responsive container, accessibility
- All 69 tests pass (5 utils + 5 PageWrapper + 19 Navigation + 13 Footer + 27 VideoPlayer)
- Lint and build pass successfully

### File List
**Created:**
- `src/components/video/VideoPlayer.tsx` - VideoPlayer component with lazy loading
- `src/components/video/index.ts` - Barrel export
- `src/components/video/VideoPlayer.test.tsx` - Unit tests (27 tests)

**Modified:**
None

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation quality is **outstanding**. The VideoPlayer component demonstrates advanced React patterns and production-ready code:

- **Modern React Patterns**: Proper use of `forwardRef`, `useImperativeHandle`, `useCallback` for optimal performance
- **State Management**: Well-organized state with clear TypeScript types (`VideoStatus` union type)
- **Lazy Loading Excellence**: IntersectionObserver implementation with configurable threshold and root margin
- **Comprehensive Event Handling**: Loading, error, play, pause states with user feedback
- **Accessibility**: `aria-label` attributes, keyboard navigation, fallback text for unsupported browsers
- **User Experience**: Loading spinner, error state UI, play button overlay, smooth interactions
- **Performance Optimization**: Lazy loading, `useCallback` for handlers, minimal re-renders
- **Multi-format Support**: Intelligent handling of extensionless vs. extension-based video sources

### Refactoring Performed

Enhanced code quality through strategic improvements:

- **File**: `src/components/video/VideoPlayer.test.tsx`
  - **Change**: Added test for autoplay behavior when `muted` and `autoplay` props are true
  - **Why**: AC2 was implemented but lacked direct test coverage - gap in requirements traceability
  - **How**: Verifies autoplay triggers when video status becomes "ready" with proper conditions

- **File**: `src/components/video/VideoPlayer.tsx`
  - **Change**: Added non-null assertion operator to `src.split(".").pop()!` on line 210
  - **Why**: TypeScript type safety - `pop()` returns `string | undefined`, but `hasExtension` check guarantees a value
  - **How**: Makes type assertion explicit and safe, improving code clarity

- **File**: `src/components/video/VideoPlayer.tsx`
  - **Change**: Extracted magic numbers to named constants (`LAZY_LOAD_THRESHOLD`, `LAZY_LOAD_ROOT_MARGIN`)
  - **Why**: Improves maintainability and self-documentation of lazy loading configuration
  - **How**: Added constants at module level with descriptive comments explaining their purpose

### Compliance Check

- **Coding Standards**: ✓ PascalCase component naming, `"use client"` directive, absolute imports with `@/` alias
- **Project Structure**: ✓ Component in `src/components/video/`, co-located tests, barrel export in `index.ts`
- **Testing Strategy**: ✓ 28 comprehensive tests using Vitest + Testing Library, organized in 11 describe blocks
- **All ACs Met**: ✓ All 9 acceptance criteria verified with comprehensive test coverage (see traceability matrix below)

### Acceptance Criteria Verification

| AC | Description | Implementation | Tests | Status |
|----|-------------|----------------|-------|--------|
| 1 | Props: src, poster, autoplay, muted, loop, className | [VideoPlayer.tsx:19-37](src/components/video/VideoPlayer.tsx#L19-L37) - VideoPlayerProps interface | Lines 62-67, 72-80, 135-186 | ✓ |
| 2 | Autoplay with muted attribute | [VideoPlayer.tsx:84-91](src/components/video/VideoPlayer.tsx#L84-L91) - useEffect for autoplay | Lines 167-186 (new test) | ✓ |
| 3 | Lazy loading with IntersectionObserver | [VideoPlayer.tsx:65-82](src/components/video/VideoPlayer.tsx#L65-L82) - threshold 0.1, rootMargin 50px | Lines 319-339 | ✓ |
| 4 | Poster image displays before load | [VideoPlayer.tsx:199](src/components/video/VideoPlayer.tsx#L199), [220-228](src/components/video/VideoPlayer.tsx#L220-L228) | Lines 70-92 | ✓ |
| 5 | Play/pause toggle on click/tap | [VideoPlayer.tsx:94-105](src/components/video/VideoPlayer.tsx#L94-L105), [172-191](src/components/video/VideoPlayer.tsx#L172-L191) | Lines 168-229 | ✓ |
| 6 | Loading and error states | [VideoPlayer.tsx:108-131](src/components/video/VideoPlayer.tsx#L108-L131), [145-170](src/components/video/VideoPlayer.tsx#L145-L170) | Lines 282-317 | ✓ |
| 7 | playsInline for iOS compatibility | [VideoPlayer.tsx:200](src/components/video/VideoPlayer.tsx#L200) | Lines 94-103 | ✓ |
| 8 | Responsive (fills width, maintains aspect ratio) | [VideoPlayer.tsx:140-142](src/components/video/VideoPlayer.tsx#L140-L142) - w-full, aspect-video | Lines 342-351 | ✓ |
| 9 | Multiple video formats (MP4, WebM) | [VideoPlayer.tsx:134](src/components/video/VideoPlayer.tsx#L134), [207-217](src/components/video/VideoPlayer.tsx#L207-L217) | Lines 106-132 | ✓ |

### Test Coverage Analysis

| Category | Tests | Coverage |
|----------|-------|----------|
| Rendering | 4 tests | Container, viewport loading, className |
| Poster Image | 2 tests | Attribute application, placeholder display |
| iOS Compatibility | 1 test | playsInline attribute |
| Video Sources | 2 tests | Multi-format and single-format |
| Video Attributes | 4 tests | muted, loop, aria-label, autoplay |
| Play/Pause Toggle | 3 tests | Button render, play, pause |
| Event Callbacks | 3 tests | onPlay, onPause, onError |
| Loading State | 1 test | Spinner display |
| Error State | 1 test | Error message display |
| Lazy Loading | 3 tests | Observer setup, disconnect, unmount |
| Responsive Container | 2 tests | aspect-video, w-full |
| Accessibility | 2 tests | Keyboard focus, fallback text |
| **Total** | **28 tests** | **100% AC coverage** |

### Improvements Checklist

- [x] Added autoplay test for complete AC2 coverage
- [x] Improved type safety with non-null assertion
- [x] Extracted magic numbers to named constants
- [x] All 9 acceptance criteria fully implemented and tested
- [ ] Consider adding `prefers-reduced-motion` support for autoplay (future enhancement)
- [ ] Consider making lazy load config props for advanced use cases (future enhancement)

### Security Review

**Excellent security posture:**
- No user input processing - component accepts only props from trusted parent components
- No XSS risks - all content is type-safe and validated
- No external API calls or data fetching
- Static content with controlled video sources
- Proper error handling without exposing internal details

### Performance Considerations

**Outstanding performance optimizations:**
- **Lazy Loading**: IntersectionObserver prevents videos from loading until near viewport (reduces initial page load)
- **Event Handler Optimization**: All event handlers use `useCallback` to prevent unnecessary re-renders
- **Minimal Re-renders**: State is carefully managed with specific update triggers
- **Multi-format Support**: Browser can choose optimal format (WebM smaller, MP4 more compatible)
- **Poster Images**: Provide visual content while video loads, improving perceived performance
- **No External Dependencies**: Uses native HTML5 video API, no heavy libraries

**Performance Metrics:**
- Component size: ~240 lines (lean implementation)
- Test execution: 631ms for 28 tests (efficient test suite)
- Build impact: No additional bundle size from external video libraries

### Files Modified During Review

**Modified:**
- `src/components/video/VideoPlayer.tsx` - Type safety improvement, extracted constants
- `src/components/video/VideoPlayer.test.tsx` - Added autoplay test (28 tests total, +1 from original)

**Note**: Test count increased from 27 to 28 tests. All tests passing.

### Gate Status

Gate: **PASS** → [docs/qa/gates/1.4-video-player-component.yml](docs/qa/gates/1.4-video-player-component.yml)

### Recommended Status

✓ **Ready for Done** - All 9 acceptance criteria met with comprehensive test coverage (28 tests), clean implementation with advanced React patterns, excellent performance optimization, and strong security posture. Minor improvements made during review enhance code quality further. No blocking issues found.
