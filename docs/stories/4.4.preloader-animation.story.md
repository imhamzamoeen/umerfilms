# Story 4.4: Preloader Animation Component

## Status
Draft

## Story
**As a** visitor,
**I want** to see a loading animation when the page first loads,
**so that** I have visual feedback during content loading.

## Acceptance Criteria

1. Preloader component created with "LOADING" text animation
2. Each letter fades in sequentially
3. After completion (~2-3s), page content slides in from bottom
4. Preloader only shows on initial page load (not on navigation)
5. State stored in sessionStorage to prevent repeat on same session
6. Smooth transition between preloader and main content
7. Accessible (screen reader announces loading state)
8. Component is lazy-loaded to avoid blocking main content
9. Tests verify animation sequence and timing
10. Works across all browsers

## Tasks / Subtasks

- [ ] Task 1: Create PreLoader Component Structure (AC: 1, 2)
  - [ ] Create `src/components/layout/PreLoader.tsx`
  - [ ] Define "LOADING" text as array of letters
  - [ ] Set up sequential fade-in animation for each letter
  - [ ] Add animation delays (100-150ms between letters)
  - [ ] Style component with full viewport coverage

- [ ] Task 2: Implement Animation Timing & Sequencing (AC: 2, 3)
  - [ ] Set total animation duration to 2-3 seconds
  - [ ] Implement letter-by-letter fade-in with stagger
  - [ ] Add page content slide-in from bottom after completion
  - [ ] Use Framer Motion or CSS keyframes for animations
  - [ ] Ensure smooth easing curves (ease-out)

- [ ] Task 3: Session State Management (AC: 4, 5)
  - [ ] Check sessionStorage on component mount
  - [ ] Store "preloaderShown" flag after completion
  - [ ] Skip animation if flag exists in sessionStorage
  - [ ] Clear sessionStorage on browser/tab close
  - [ ] Ensure animation shows on fresh session

- [ ] Task 4: Smooth Transitions (AC: 6)
  - [ ] Fade out preloader (opacity 0) after animation
  - [ ] Slide main content up from bottom (translateY)
  - [ ] Coordinate timing between preloader exit and content entry
  - [ ] Use 0.4-0.6s transition duration
  - [ ] Remove preloader from DOM after exit animation

- [ ] Task 5: Accessibility Implementation (AC: 7)
  - [ ] Add ARIA live region for screen reader announcement
  - [ ] Announce "Loading page content" to assistive technologies
  - [ ] Ensure preloader doesn't block keyboard navigation
  - [ ] Add `role="alert"` for loading state
  - [ ] Test with NVDA and JAWS screen readers

- [ ] Task 6: Lazy Loading & Performance (AC: 8)
  - [ ] Lazy load preloader component with React.lazy()
  - [ ] Add Suspense boundary for preloader
  - [ ] Ensure main content is not blocked by preloader
  - [ ] Optimize animation performance (GPU acceleration)
  - [ ] Test on low-end devices

- [ ] Task 7: Component Testing (AC: 9)
  - [ ] Create `PreLoader.test.tsx` with Vitest
  - [ ] Test letter animation sequence and timing
  - [ ] Test sessionStorage state management
  - [ ] Mock sessionStorage for tests
  - [ ] Test component unmounts after completion

- [ ] Task 8: Cross-Browser Testing (AC: 10)
  - [ ] Test on Chrome (latest)
  - [ ] Test on Firefox (latest)
  - [ ] Test on Safari (latest)
  - [ ] Test on Edge (latest)
  - [ ] Verify animations work consistently

## Dev Notes

### Preloader Specification
[Source: idea.md - Animations & micro-interactions section, changes.md section 4]

**From idea.md:**
- "LOADING" animation appears on page load
- Each letter fades in sequentially
- After completion, page content slides in from bottom
- Duration: ~2-3 seconds

**Animation Sequence:**
1. Show black background with "LOADING" text
2. Fade in each letter: L → O → A → D → I → N → G
3. Hold for 0.5s after last letter
4. Fade out entire preloader
5. Slide in main page content from bottom

### Animation Implementation
[Source: idea.md - Animations section]

**Framer Motion Approach (Recommended):**

```tsx
// src/components/layout/PreLoader.tsx
'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { useState, useEffect } from 'react';

export default function PreLoader() {
  const [isVisible, setIsVisible] = useState(false);
  const letters = 'LOADING'.split('');

  useEffect(() => {
    // Check if preloader was already shown in this session
    const hasShown = sessionStorage.getItem('preloaderShown');

    if (!hasShown) {
      setIsVisible(true);

      // Hide after animation completes
      const timer = setTimeout(() => {
        setIsVisible(false);
        sessionStorage.setItem('preloaderShown', 'true');
      }, 2500);

      return () => clearTimeout(timer);
    }
  }, []);

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.15,
      },
    },
    exit: {
      opacity: 0,
      transition: { duration: 0.5 },
    },
  };

  const letterVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.4, ease: 'easeOut' },
    },
  };

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          className="fixed inset-0 z-50 flex items-center justify-center bg-black"
          variants={containerVariants}
          initial="hidden"
          animate="visible"
          exit="exit"
          role="alert"
          aria-live="polite"
          aria-label="Loading page content"
        >
          <motion.div className="flex gap-2 text-6xl font-bold text-white">
            {letters.map((letter, index) => (
              <motion.span key={index} variants={letterVariants}>
                {letter}
              </motion.span>
            ))}
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

**CSS Keyframes Alternative:**

```css
/* globals.css */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.preloader-letter {
  animation: fadeInUp 0.4s ease-out forwards;
  opacity: 0;
}

.preloader-letter:nth-child(1) { animation-delay: 0s; }
.preloader-letter:nth-child(2) { animation-delay: 0.15s; }
.preloader-letter:nth-child(3) { animation-delay: 0.3s; }
.preloader-letter:nth-child(4) { animation-delay: 0.45s; }
.preloader-letter:nth-child(5) { animation-delay: 0.6s; }
.preloader-letter:nth-child(6) { animation-delay: 0.75s; }
.preloader-letter:nth-child(7) { animation-delay: 0.9s; }
```

### Component Location
[Source: docs/architecture/unified-project-structure.md]

**File to Create:**
- `src/components/layout/PreLoader.tsx`

**Integration Point:**
- Add to `src/app/layout.tsx` (root layout)
- Place as first child in body for immediate rendering

**Root Layout Integration:**
```tsx
// src/app/layout.tsx
import PreLoader from '@/components/layout/PreLoader';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={geistSans.className}>
        <PreLoader />
        {children}
      </body>
    </html>
  );
}
```

### Session Storage Strategy
[Source: idea.md section 4, changes.md section 4]

**Session Management:**
- Use `sessionStorage` (not `localStorage`) for session-scoped persistence
- Clear on browser/tab close automatically
- Show preloader on:
  - First visit in new session
  - Browser refresh with cleared sessionStorage
  - New tab/window

**Implementation:**
```typescript
// Check on mount
useEffect(() => {
  const hasShown = sessionStorage.getItem('preloaderShown');
  if (!hasShown) {
    setIsVisible(true);
  }
}, []);

// Set after animation
const handleAnimationComplete = () => {
  sessionStorage.setItem('preloaderShown', 'true');
  setIsVisible(false);
};
```

### Accessibility Considerations
[Source: idea.md - Semantic & accessible section]

**Screen Reader Support:**
- Use `role="alert"` for loading state announcement
- Add `aria-live="polite"` for non-intrusive updates
- Provide descriptive `aria-label`
- Announce completion to screen readers

**ARIA Implementation:**
```tsx
<div
  role="alert"
  aria-live="polite"
  aria-label="Loading page content"
  className="preloader"
>
  {/* Loading animation */}
</div>
```

**Keyboard Navigation:**
- Preloader should not trap focus
- Main content should be focusable immediately after preloader
- No interactive elements in preloader

### Performance Optimization
[Source: idea.md - Technical fidelity section]

**Lazy Loading:**
```tsx
// src/app/layout.tsx
import { lazy, Suspense } from 'react';

const PreLoader = lazy(() => import('@/components/layout/PreLoader'));

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <Suspense fallback={null}>
          <PreLoader />
        </Suspense>
        {children}
      </body>
    </html>
  );
}
```

**GPU Acceleration:**
- Use `transform` and `opacity` for animations (GPU-accelerated properties)
- Avoid animating `width`, `height`, `top`, `left`
- Add `will-change: transform, opacity` for complex animations

**Animation Performance:**
```css
.preloader {
  will-change: transform, opacity;
  transform: translateZ(0); /* Force GPU acceleration */
}
```

### Timing Configuration
[Source: idea.md section 4]

**Animation Timeline:**
- Letter animation: 1.05s (7 letters × 0.15s)
- Hold duration: 0.5s
- Fade out: 0.5s
- Total: ~2.5s

**Configurable Timing:**
```typescript
const ANIMATION_CONFIG = {
  letterDelay: 150, // ms between letters
  holdDuration: 500, // ms to hold after last letter
  fadeOutDuration: 500, // ms to fade out
  totalDuration: 2500, // ms total
};
```

### Page Content Entry Animation
[Source: idea.md - Animations section, changes.md section 4]

**Content Slide-In:**
- Main content starts below viewport (translateY(100%))
- Slides up as preloader fades out
- Smooth ease-out transition (0.6s)

**Implementation:**
```tsx
// src/app/layout.tsx
const [preloaderComplete, setPreloaderComplete] = useState(false);

return (
  <motion.div
    initial={{ y: 100, opacity: 0 }}
    animate={preloaderComplete ? { y: 0, opacity: 1 } : {}}
    transition={{ duration: 0.6, ease: 'easeOut' }}
  >
    {children}
  </motion.div>
);
```

### Typography & Styling
[Source: idea.md - Typography section]

**Letter Styling:**
- Font size: 4-6rem (64-96px) on desktop
- Font weight: 800 (extrabold)
- Text color: white (#FFFFFF)
- Background: black (#000000)
- Letter spacing: 0.1em for spacing

**Responsive Sizing:**
```css
.preloader-text {
  font-size: clamp(3rem, 8vw, 6rem);
  font-weight: 800;
  letter-spacing: 0.1em;
  color: #FFFFFF;
}
```

### Component Testing
[Source: docs/architecture/testing-strategy.md]

**Test File:** `src/components/layout/PreLoader.test.tsx`

**Tests to Implement:**
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import PreLoader from './PreLoader';

describe('PreLoader', () => {
  beforeEach(() => {
    sessionStorage.clear();
    vi.useFakeTimers();
  });

  it('renders loading text with all letters', () => {
    render(<PreLoader />);
    expect(screen.getByText(/loading/i)).toBeInTheDocument();
  });

  it('shows on first visit', () => {
    render(<PreLoader />);
    expect(screen.getByRole('alert')).toBeVisible();
  });

  it('hides after animation completes', async () => {
    render(<PreLoader />);

    vi.advanceTimersByTime(2500);

    await waitFor(() => {
      expect(screen.queryByRole('alert')).not.toBeInTheDocument();
    });
  });

  it('stores flag in sessionStorage after completion', async () => {
    render(<PreLoader />);

    vi.advanceTimersByTime(2500);

    await waitFor(() => {
      expect(sessionStorage.getItem('preloaderShown')).toBe('true');
    });
  });

  it('skips animation if already shown in session', () => {
    sessionStorage.setItem('preloaderShown', 'true');

    render(<PreLoader />);

    expect(screen.queryByRole('alert')).not.toBeInTheDocument();
  });

  it('announces loading to screen readers', () => {
    render(<PreLoader />);
    const preloader = screen.getByRole('alert');

    expect(preloader).toHaveAttribute('aria-live', 'polite');
    expect(preloader).toHaveAttribute('aria-label', 'Loading page content');
  });
});
```

### Dependencies
[Source: Epic 4 definition]

**Story Dependencies:**
- Depends on Story 4.1 (color palette) for consistent styling
- Should be implemented before Story 4.5 (off-canvas menu)

**Package Dependencies:**
```bash
# If using Framer Motion
npm install framer-motion

# Already installed:
# - React 19
# - Next.js 16
```

### Browser Compatibility
[Source: idea.md - Technical fidelity section]

**Animation Support:**
- CSS animations: All modern browsers ✓
- Framer Motion: Chrome, Firefox, Safari, Edge ✓
- sessionStorage: All modern browsers ✓

**Testing Checklist:**
- [ ] Chrome (latest): Animation smooth
- [ ] Firefox (latest): Animation smooth
- [ ] Safari (latest): Animation smooth
- [ ] Edge (latest): Animation smooth
- [ ] Mobile Safari: Animation smooth
- [ ] Mobile Chrome: Animation smooth

### Constraints
- **NO blocking:** Preloader must not block main content loading
- **Performance:** Animation must be smooth (60fps)
- **Accessibility:** Must be screen reader friendly
- **Session-scoped:** Only show once per browser session

### Visual Reference
[Source: idea.md section 4]

**Effect Description:**
- Black screen with white "LOADING" text
- Letters appear one by one from left to right
- Each letter fades up slightly as it appears
- After all letters visible, entire preloader fades out
- Main content slides in from bottom

### Implementation Order
1. ✅ Create PreLoader component structure
2. ✅ Implement letter-by-letter animation
3. ✅ Add sessionStorage state management
4. ✅ Integrate into root layout
5. ✅ Add accessibility attributes
6. ✅ Implement page content entry animation
7. ✅ Write component tests
8. ✅ Cross-browser testing

## Testing

[Source: docs/architecture/testing-strategy.md]

**Test Types:**
1. **Component Tests:** Verify animation sequence, timing, sessionStorage
2. **Accessibility Tests:** Screen reader announcements, ARIA attributes
3. **Visual Tests:** Animation smoothness, timing accuracy
4. **Performance Tests:** No blocking, smooth 60fps

**Test Commands:**
```bash
npm test                           # Run all tests
npm test PreLoader.test            # Test preloader specifically
```

**Expected Results:**
- All tests pass
- Animation plays smoothly on first visit
- Preloader skips on subsequent navigation
- Screen readers announce loading state

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 1.0 | Initial story draft | Claude |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA agent after implementation_
